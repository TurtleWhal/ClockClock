<!DOCTYPE html>
<html>

<head>
  <title>ClockClock</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <!-- <link rel="icon" href="data:,"> -->
  <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
  <h1>ClockClock</h1>
  <canvas id="canvas"></canvas>
  <h1 id="status">Not Connected</h1>

  <script>
    var hands = [];

    for (let i = 0; i < 8; i++) {
      hands[i] = [];
      for (let j = 0; j < 3; j++) {
        hands[i][j] = [10 * i, 360 - 10 * i];
      }
    }

    var gateway = `ws://${window.location.hostname}/ws`;
    var websocket;
    window.addEventListener('load', onLoad);

    function initWebSocket() {
      console.log('Trying to open a WebSocket connection...');
      websocket = new WebSocket(gateway);
      websocket.onopen = onOpen;
      websocket.onclose = onClose;
      websocket.onmessage = onMessage; // <-- add this line
    }

    function onOpen(event) {
      console.log('Connection opened');
      document.getElementById("status").innerHTML = "Connected";
    }

    function onClose(event) {
      console.log('Connection closed');
      document.getElementById("status").innerHTML = "Not Connected";

      setTimeout(initWebSocket, 10000); // wait 10 seconds to try to reconnect
    }

    function onMessage(event) {
      hands = JSON.parse(event.data)["buffer"];
      console.log(hands);
      draw();
    }

    function onLoad(event) {
      initWebSocket();
    }

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    canvas.height = 300;
    canvas.width = 800;

    draw();

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      for (let y = 0; y < 3; y++) {
        for (let x = 0; x < 8; x++) {

          const gradient = ctx.createLinearGradient(y * 100, x * 100, (y + 1) * 100, (x + 1) * 100);

          // Add three color stops
          gradient.addColorStop(0, "#000");
          gradient.addColorStop(0.2, "#222");
          gradient.addColorStop(0.4, "#222");
          gradient.addColorStop(1, "#333");

          // draw background of hands
          ctx.fillStyle = gradient;
          ctx.beginPath();
          ctx.arc(50 + x * 100, 50 + y * 100, 50, 0, 2 * Math.PI);
          ctx.fill();

          // draw shadow of bottom hand
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.moveTo(53 + x * 100, 53 + y * 100);
          ctx.lineTo(53 + x * 100 + Math.cos(hands[x][y][0] * Math.PI / 180) * 45, 53 + y * 100 + Math.sin(hands[x][y][0] * Math.PI / 180) * 45);
          ctx.stroke();

          // draw bottom hand
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.moveTo(50 + x * 100, 50 + y * 100);
          ctx.lineTo(50 + x * 100 + Math.cos(hands[x][y][0] * Math.PI / 180) * 45, 50 + y * 100 + Math.sin(hands[x][y][0] * Math.PI / 180) * 45);
          ctx.stroke();


          // draw shadow of top hand
          ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.moveTo(53 + x * 100, 53 + y * 100);
          ctx.lineTo(53 + x * 100 + Math.cos(hands[x][y][1] * Math.PI / 180) * 45, 53 + y * 100 + Math.sin(hands[x][y][1] * Math.PI / 180) * 45);
          ctx.stroke();

          // draw circle in center
          ctx.beginPath();
          ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
          ctx.arc(53 + x * 100, 53 + y * 100, 6, hands[x][y][1] * (Math.PI / 180) + Math.PI / 2, hands[x][y][1] * (Math.PI / 180) - Math.PI / 2);
          ctx.fill();

          // draw circle in center
          ctx.beginPath();
          ctx.fillStyle = '#fff';
          ctx.arc(50 + x * 100, 50 + y * 100, 6, 0, 2 * Math.PI);
          ctx.fill();

          // draw top hand
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 12;
          ctx.beginPath();
          ctx.moveTo(50 + x * 100, 50 + y * 100);
          ctx.lineTo(50 + x * 100 + Math.cos(hands[x][y][1] * Math.PI / 180) * 45, 50 + y * 100 + Math.sin(hands[x][y][1] * Math.PI / 180) * 45);
          ctx.stroke();
        }
      }
    }
  </script>
</body>

</html>